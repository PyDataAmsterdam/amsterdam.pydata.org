{"version":3,"file":"lambda.js","names":["cdnDatastore","PATH_PREFIX","setupFsWrapper","fs","accessSync","__filename","constants","W_OK","path","join","__dirname","e","TEMP_DIR","tmpdir","TEMP_CACHE_DIR","global","__GATSBY","root","cacheDir","process","cwd","rewrites","console","log","from","to","mapPathUsingRewrites","fsPath","filename","resolve","String","indexOf","rootRegex","isRoot","match","baseRegex","replace","regex","RegExp","sep","_match","_p1","p2","applyRename","fsToRewrite","lfs","method","original","args","apply","linkRewritableMethods","push","createLinkedFS","linkedFS","link","key","Object","hasOwnProperty","call","native","promises","originalWritesStream","WriteStream","LinkedWriteStream","flags","prototype","create","originalReadStream","ReadStream","LinkedReadStream","dbPath","_fsWrapper","dir","env","NETLIFY_LOCAL","existsSync","copySync","buildId","imageCDNUrlGeneratorModulePath","require","fileCDNUrlGeneratorModulePath","GraphQLEngine","getData","renderPageData","renderHTML","streamPipeline","promisify","pipeline","get","url","callback","URL","protocol","httpsGet","httpGet","getEngine","downloadPath","ensureDir","Promise","reject","req","response","statusCode","Error","statusMessage","fileStream","createWriteStream","then","catch","error","on","graphqlEngine","ready","engineReadyPromise","reverseFixedPagePath","pageDataRequestPath","getPathInfo","requestPath","matches","matchAll","requestedPagePath","isPageData","pagePath","setStatusAndHeaders","page","data","res","mode","serverDataStatus","status","serverDataHeaders","name","value","entries","setHeader","getErrorBody","body","readFileSync","getPage","pathname","pathInfo","undefined","findPageByPath","engineHandler","pageInfo","originalPathName","startsWith","maybePath","slice","length","send","pathName","results","json"],"sources":["../../../src/utils/page-ssr-module/lambda.ts"],"sourcesContent":["import type { GatsbyFunctionResponse, GatsbyFunctionRequest } from \"gatsby\"\nimport * as path from \"path\"\nimport * as fs from \"fs-extra\"\nimport { get as httpsGet } from \"https\"\nimport { get as httpGet, IncomingMessage, ClientRequest } from \"http\"\nimport { tmpdir } from \"os\"\nimport { pipeline } from \"stream\"\nimport { URL } from \"url\"\nimport { promisify } from \"util\"\n\nimport type { IGatsbyPage } from \"../../internal\"\nimport type { ISSRData } from \"./entry\"\nimport { link, rewritableMethods as linkRewritableMethods } from \"linkfs\"\n\nconst cdnDatastore = `%CDN_DATASTORE_PATH%`\nconst PATH_PREFIX = `%PATH_PREFIX%`\n\nfunction setupFsWrapper(): string {\n  // setup global._fsWrapper\n  try {\n    fs.accessSync(__filename, fs.constants.W_OK)\n    // TODO: this seems funky - not sure if this is correct way to handle this, so just marking TODO to revisit this\n    return path.join(__dirname, `..`, `data`, `datastore`)\n  } catch (e) {\n    // we are in a read-only filesystem, so we need to use a temp dir\n\n    const TEMP_DIR = path.join(tmpdir(), `gatsby`)\n    const TEMP_CACHE_DIR = path.join(TEMP_DIR, `.cache`)\n\n    global.__GATSBY.root = TEMP_DIR\n\n    // TODO: don't hardcode this\n    const cacheDir = `${process.cwd()}/.cache`\n\n    // we need to rewrite fs\n    const rewrites = [\n      [path.join(cacheDir, `caches`), path.join(TEMP_CACHE_DIR, `caches`)],\n      [\n        path.join(cacheDir, `caches-lmdb`),\n        path.join(TEMP_CACHE_DIR, `caches-lmdb`),\n      ],\n      [path.join(cacheDir, `data`), path.join(TEMP_CACHE_DIR, `data`)],\n    ]\n\n    console.log(`Preparing Gatsby filesystem`, {\n      from: cacheDir,\n      to: TEMP_CACHE_DIR,\n      rewrites,\n    })\n\n    // copied from https://github.com/streamich/linkfs/blob/master/src/index.ts#L126-L142\n    function mapPathUsingRewrites(fsPath: fs.PathLike): string {\n      let filename = path.resolve(String(fsPath))\n      for (const [from, to] of rewrites) {\n        if (filename.indexOf(from) === 0) {\n          const rootRegex = /(?:^[a-zA-Z]:\\\\$)|(?:^\\/$)/ // C:\\ vs /\n          const isRoot = from.match(rootRegex)\n          const baseRegex = `^(` + from.replace(/\\\\/g, `\\\\\\\\`) + `)`\n\n          if (isRoot) {\n            const regex = new RegExp(baseRegex)\n            filename = filename.replace(regex, () => to + path.sep)\n          } else {\n            const regex = new RegExp(baseRegex + `(\\\\\\\\|/|$)`)\n            filename = filename.replace(regex, (_match, _p1, p2) => to + p2)\n          }\n        }\n      }\n      return filename\n    }\n\n    function applyRename<\n      T = typeof import(\"fs\") | typeof import(\"fs\").promises\n    >(fsToRewrite: T, lfs: T, method: \"rename\" | \"renameSync\"): void {\n      const original = fsToRewrite[method]\n      if (original) {\n        // @ts-ignore - complains about __promisify__ which doesn't actually exist in runtime\n        lfs[method] = (\n          ...args: Parameters<typeof import(\"fs\")[\"rename\" | \"renameSync\"]>\n        ): ReturnType<typeof import(\"fs\")[\"rename\" | \"renameSync\"]> => {\n          args[0] = mapPathUsingRewrites(args[0])\n          args[1] = mapPathUsingRewrites(args[1])\n          // @ts-ignore - can't decide which signature this is, but we just preserve the original\n          // signature here and mostly care about first 2 arguments being PathLike\n          return original.apply(fsToRewrite, args)\n        }\n      }\n    }\n\n    // linkfs doesn't handle following methods, so we need to add them manually\n    linkRewritableMethods.push(`createWriteStream`, `createReadStream`, `rm`)\n\n    function createLinkedFS<\n      T = typeof import(\"fs\") | typeof import(\"fs\").promises\n    >(fsToRewrite: T): T {\n      const linkedFS = link(fsToRewrite, rewrites) as T\n\n      // linkfs doesn't handle `to` argument in `rename` and `renameSync` methods\n      applyRename(fsToRewrite, linkedFS, `rename`)\n      applyRename(fsToRewrite, linkedFS, `renameSync`)\n\n      return linkedFS\n    }\n\n    // Alias the cache dir paths to the temp dir\n    const lfs = createLinkedFS(fs)\n\n    // linkfs doesn't pass across the `native` prop, which graceful-fs needs\n    for (const key in lfs) {\n      if (Object.hasOwnProperty.call(fs[key], `native`)) {\n        lfs[key].native = fs[key].native\n      }\n    }\n    // 'promises' is not initially linked within the 'linkfs'\n    // package, and is needed by underlying Gatsby code (the\n    // @graphql-tools/code-file-loader)\n    lfs.promises = createLinkedFS(fs.promises)\n\n    const originalWritesStream = fs.WriteStream\n    function LinkedWriteStream(\n      this: fs.WriteStream,\n      ...args: Parameters<(typeof fs)[\"createWriteStream\"]>\n    ): fs.WriteStream {\n      args[0] = mapPathUsingRewrites(args[0])\n      args[1] =\n        typeof args[1] === `string`\n          ? {\n              flags: args[1],\n              // @ts-ignore there is `fs` property in options doh (https://nodejs.org/api/fs.html#fscreatewritestreampath-options)\n              fs: lfs,\n            }\n          : {\n              ...(args[1] || {}),\n              // @ts-ignore there is `fs` property in options doh (https://nodejs.org/api/fs.html#fscreatewritestreampath-options)\n              fs: lfs,\n            }\n\n      // @ts-ignore TS doesn't like extending prototype \"classes\"\n      return originalWritesStream.apply(this, args)\n    }\n    LinkedWriteStream.prototype = Object.create(originalWritesStream.prototype)\n    // @ts-ignore TS doesn't like extending prototype \"classes\"\n    lfs.WriteStream = LinkedWriteStream\n\n    const originalReadStream = fs.ReadStream\n    function LinkedReadStream(\n      this: fs.ReadStream,\n      ...args: Parameters<(typeof fs)[\"createReadStream\"]>\n    ): fs.ReadStream {\n      args[0] = mapPathUsingRewrites(args[0])\n      args[1] =\n        typeof args[1] === `string`\n          ? {\n              flags: args[1],\n              // @ts-ignore there is `fs` property in options doh (https://nodejs.org/api/fs.html#fscreatewritestreampath-options)\n              fs: lfs,\n            }\n          : {\n              ...(args[1] || {}),\n              // @ts-ignore there is `fs` property in options doh (https://nodejs.org/api/fs.html#fscreatewritestreampath-options)\n              fs: lfs,\n            }\n\n      // @ts-ignore TS doesn't like extending prototype \"classes\"\n      return originalReadStream.apply(this, args)\n    }\n    LinkedReadStream.prototype = Object.create(originalReadStream.prototype)\n    // @ts-ignore TS doesn't like extending prototype \"classes\"\n    lfs.ReadStream = LinkedReadStream\n\n    const dbPath = path.join(TEMP_CACHE_DIR, `data`, `datastore`)\n\n    // Gatsby uses this instead of fs if present\n    // eslint-disable-next-line no-underscore-dangle\n    // @ts-ignore __promisify__ stuff\n    global._fsWrapper = lfs\n\n    if (!cdnDatastore) {\n      const dir = `data`\n      if (\n        !process.env.NETLIFY_LOCAL &&\n        fs.existsSync(path.join(TEMP_CACHE_DIR, dir))\n      ) {\n        console.log(`directory already exists`)\n        return dbPath\n      }\n      console.log(`Start copying ${dir}`)\n\n      fs.copySync(path.join(cacheDir, dir), path.join(TEMP_CACHE_DIR, dir))\n      console.log(`End copying ${dir}`)\n    }\n\n    return dbPath\n  }\n}\n\nglobal.__GATSBY = {\n  root: process.cwd(),\n  buildId: ``,\n}\n\n// eslint-disable-next-line no-constant-condition\nif (`%IMAGE_CDN_URL_GENERATOR_MODULE_RELATIVE_PATH%`) {\n  global.__GATSBY.imageCDNUrlGeneratorModulePath = require.resolve(\n    `%IMAGE_CDN_URL_GENERATOR_MODULE_RELATIVE_PATH%`\n  )\n}\n// eslint-disable-next-line no-constant-condition\nif (`%FILE_CDN_URL_GENERATOR_MODULE_RELATIVE_PATH%`) {\n  global.__GATSBY.fileCDNUrlGeneratorModulePath = require.resolve(\n    `%FILE_CDN_URL_GENERATOR_MODULE_RELATIVE_PATH%`\n  )\n}\n\nconst dbPath = setupFsWrapper()\n\n// using require instead of import here for now because of type hell + import path doesn't exist in current context\n// as this file will be copied elsewhere\n\ntype GraphQLEngineType =\n  import(\"../../schema/graphql-engine/entry\").GraphQLEngine\n\nconst { GraphQLEngine } =\n  require(`../query-engine`) as typeof import(\"../../schema/graphql-engine/entry\")\n\nconst { getData, renderPageData, renderHTML } =\n  require(`./index`) as typeof import(\"./entry\")\n\nconst streamPipeline = promisify(pipeline)\n\nfunction get(\n  url: string,\n  callback?: (res: IncomingMessage) => void\n): ClientRequest {\n  return new URL(url).protocol === `https:`\n    ? httpsGet(url, callback)\n    : httpGet(url, callback)\n}\n\nasync function getEngine(): Promise<GraphQLEngineType> {\n  if (cdnDatastore) {\n    // if this variable is set we need to download the datastore from the CDN\n    const downloadPath = dbPath + `/data.mdb`\n    console.log(\n      `Downloading datastore from CDN (${cdnDatastore} -> ${downloadPath})`\n    )\n\n    await fs.ensureDir(dbPath)\n    await new Promise((resolve, reject) => {\n      const req = get(cdnDatastore, response => {\n        if (\n          !response.statusCode ||\n          response.statusCode < 200 ||\n          response.statusCode > 299\n        ) {\n          reject(\n            new Error(\n              `Failed to download ${cdnDatastore}: ${response.statusCode} ${\n                response.statusMessage || ``\n              }`\n            )\n          )\n          return\n        }\n\n        const fileStream = fs.createWriteStream(downloadPath)\n        streamPipeline(response, fileStream)\n          .then(resolve)\n          .catch(error => {\n            console.log(`Error downloading ${cdnDatastore}`, error)\n            reject(error)\n          })\n      })\n\n      req.on(`error`, error => {\n        console.log(`Error downloading ${cdnDatastore}`, error)\n        reject(error)\n      })\n    })\n    console.log(`Downloaded datastore from CDN`)\n  }\n\n  const graphqlEngine = new GraphQLEngine({\n    dbPath,\n  })\n\n  await graphqlEngine.ready\n\n  return graphqlEngine\n}\n\nconst engineReadyPromise = getEngine()\n\nfunction reverseFixedPagePath(pageDataRequestPath: string): string {\n  return pageDataRequestPath === `index` ? `/` : pageDataRequestPath\n}\n\nfunction getPathInfo(requestPath: string):\n  | {\n      isPageData: boolean\n      pagePath: string\n    }\n  | undefined {\n  const matches = requestPath.matchAll(/^\\/?page-data\\/(.+)\\/page-data.json$/gm)\n  for (const [, requestedPagePath] of matches) {\n    return {\n      isPageData: true,\n      pagePath: reverseFixedPagePath(requestedPagePath),\n    }\n  }\n\n  // if not matched\n  return {\n    isPageData: false,\n    pagePath: requestPath,\n  }\n}\n\nfunction setStatusAndHeaders({\n  page,\n  data,\n  res,\n}: {\n  page: IGatsbyPage\n  data: ISSRData\n  res: GatsbyFunctionResponse\n}): void {\n  if (page.mode === `SSR`) {\n    if (data.serverDataStatus) {\n      res.status(data.serverDataStatus)\n    }\n  }\n  if (data.serverDataHeaders) {\n    for (const [name, value] of Object.entries(data.serverDataHeaders)) {\n      res.setHeader(name, value)\n    }\n  }\n}\n\nfunction getErrorBody(statusCode: number): string {\n  let body = `<html><body><h1>${statusCode}</h1><p>${\n    statusCode === 404 ? `Not found` : `Internal Server Error`\n  }</p></body></html>`\n\n  if (statusCode === 404 || statusCode === 500) {\n    const filename = path.join(process.cwd(), `public`, `${statusCode}.html`)\n\n    if (fs.existsSync(filename)) {\n      body = fs.readFileSync(filename, `utf8`)\n    }\n  }\n\n  return body\n}\n\ninterface IPageInfo {\n  page: IGatsbyPage\n  isPageData: boolean\n  pagePath: string\n}\n\nfunction getPage(\n  pathname: string,\n  graphqlEngine: GraphQLEngineType\n): IPageInfo | undefined {\n  const pathInfo = getPathInfo(pathname)\n  if (!pathInfo) {\n    return undefined\n  }\n\n  const { isPageData, pagePath } = pathInfo\n\n  const page = graphqlEngine.findPageByPath(pagePath)\n  if (!page) {\n    return undefined\n  }\n\n  return {\n    page,\n    isPageData,\n    pagePath,\n  }\n}\n\nasync function engineHandler(\n  req: GatsbyFunctionRequest,\n  res: GatsbyFunctionResponse\n): Promise<void> {\n  try {\n    const graphqlEngine = await engineReadyPromise\n    let pageInfo: IPageInfo | undefined\n\n    const originalPathName = req.url ?? ``\n\n    if (PATH_PREFIX && originalPathName.startsWith(PATH_PREFIX)) {\n      const maybePath = originalPathName.slice(PATH_PREFIX.length)\n      pageInfo = getPage(maybePath, graphqlEngine)\n    }\n\n    if (!pageInfo) {\n      pageInfo = getPage(originalPathName, graphqlEngine)\n    }\n\n    if (!pageInfo) {\n      res.status(404).send(getErrorBody(404))\n      return\n    }\n\n    const { pagePath, isPageData, page } = pageInfo\n\n    const data = await getData({\n      pathName: pagePath,\n      graphqlEngine,\n      req,\n    })\n\n    if (isPageData) {\n      const results = await renderPageData({ data })\n      setStatusAndHeaders({ page, data, res })\n      res.json(results)\n      return\n    } else {\n      const results = await renderHTML({ data })\n      setStatusAndHeaders({ page, data, res })\n      res.send(results)\n      return\n    }\n  } catch (e) {\n    console.error(`Engine failed to handle request`, e)\n    res.status(500).send(getErrorBody(500))\n  }\n}\n\nexport default engineHandler\n"],"mappings":"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"}