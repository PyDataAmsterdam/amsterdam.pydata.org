{"version":3,"file":"api-runner-node.js","names":["Promise","require","_","chalk","bindActionCreators","origBindActionCreators","memoize","tracer","globalTracer","reporter","stackTrace","codeFrameColumns","fs","getCache","createContentDigest","_createContentDigest","emitter","store","getNodes","getNode","getNodesByType","getNodeAndSavePathDependency","loadNodeContent","getPublicPath","importGatsbyPlugin","getNonGatsbyCodeFrameFormatted","trackBuildError","decorateEvent","node","internal","type","contentDigest","undefined","owner","fieldOwners","ignoreType","counter","fields","process","env","BLUEBIRD_DEBUG","BLUEBIRD_LONG_STACK_TRACES","config","longStackTraces","nodeMutationsWrappers","id","wrapNode","wrapNodes","boundPluginActionCreators","doubleBind","boundActionCreators","api","plugin","actionOptions","traceId","deferNodeMutation","defer","actionKey","name","keys","Object","doubleBoundActionCreators","i","length","key","boundActionCreator","args","reportOnce","initAPICallTracing","parentSpan","startSpan","spanName","spanArgs","defaultSpanArgs","childOf","merge","deferredAction","resolve","emit","payload","NODE_MUTATION_ACTIONS","deferActions","actions","deferred","forEach","action","getLocalReporter","activity","panicOnBuild","bind","getErrorMapWithPluginName","pluginName","errorMap","entries","reduce","memo","val","extendLocalReporterToCatchPluginErrors","runningActivities","setErrorMap","error","panic","errorMeta","activityTimer","text","activityArgs","apply","originalStart","start","originalEnd","end","add","delete","createProgress","total","originalDone","done","getUninitializedCache","message","get","Error","set","del","availableActionsCache","Map","publicPath","runAPI","gatsbyNode","spanOptions","pluginSpan","setTag","publicActions","restrictedActionsAvailableInAPI","availableActions","has","dispatch","program","getState","pathPrefix","prefixPaths","namespacedCreateNodeId","createNodeId","tracing","cache","apiFinished","alreadyDisplayed","createPageAction","createPage","warning","stripIndent","bold","possiblyCodeFrame","push","warn","join","localReporter","Set","extendedLocalReporter","endInProgressActivitiesCreatedByThisRun","shouldDetectNodeMutations","includes","apiCallArgs","basePath","schema","buildObjectType","buildUnionType","buildInterfaceType","buildInputObjectType","buildEnumType","buildScalarType","pluginOptions","fromCallback","callback","cb","err","finish","e","version","apisRunningById","apisRunningByTraceId","waitingForCasacadeToFinish","apiRunnerNode","pluginSource","plugins","flattenedPlugins","implementingPlugins","filter","nodeAPIs","traceTags","waitForCascadingActions","apiSpanArgs","apiSpan","value","apiRunInstance","span","startTime","Date","toJSON","filename","page","path","argsJson","JSON","stringify","omit","size","currentCount","stopQueuedApiRuns","onAPIRunComplete","actionHandler","on","off","apiRunPromiseOptions","runPromise","GATSBY_EXPERIMENTAL_PARALLEL_SOURCING","map","concurrency","mapSeries","then","shouldOnCreateNode","catch","file","parse","find","test","fileName","codeFrame","structuredError","errorParser","lineNumber","line","columnNumber","column","trimmedFileName","match","code","readFileSync","encoding","highlightCode","_e","location","filePath","context","results","result","isEmpty","instance","apisByTraceIdCount","module","exports"],"sources":["../../src/utils/api-runner-node.js"],"sourcesContent":["const Promise = require(`bluebird`)\nconst _ = require(`lodash`)\nconst chalk = require(`chalk`)\nconst { bindActionCreators: origBindActionCreators } = require(`redux`)\nconst memoize = require(`memoizee`)\n\nconst bindActionCreators = memoize(origBindActionCreators)\n\nconst tracer = require(`opentracing`).globalTracer()\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst stackTrace = require(`stack-trace`)\nconst { codeFrameColumns } = require(`@babel/code-frame`)\nconst fs = require(`fs-extra`)\nconst { getCache } = require(`./get-cache`)\nimport { createNodeId } from \"./create-node-id\"\nconst {\n  createContentDigest: _createContentDigest,\n} = require(`gatsby-core-utils`)\nimport {\n  buildObjectType,\n  buildUnionType,\n  buildInterfaceType,\n  buildInputObjectType,\n  buildEnumType,\n  buildScalarType,\n} from \"../schema/types/type-builders\"\nconst { emitter, store } = require(`../redux`)\nconst { getNodes, getNode, getNodesByType } = require(`../datastore`)\nconst { getNodeAndSavePathDependency, loadNodeContent } = require(`./nodes`)\nconst { getPublicPath } = require(`./get-public-path`)\nconst { importGatsbyPlugin } = require(`./import-gatsby-plugin`)\nconst { getNonGatsbyCodeFrameFormatted } = require(`./stack-trace-utils`)\nconst { trackBuildError, decorateEvent } = require(`gatsby-telemetry`)\nimport errorParser from \"./api-runner-error-parser\"\nimport { wrapNode, wrapNodes } from \"./detect-node-mutations\"\nimport { reportOnce } from \"./report-once\"\n\n// Override createContentDigest to remove autogenerated data from nodes to\n// ensure consistent digests.\nfunction createContentDigest(node) {\n  if (!node?.internal?.type) {\n    // this doesn't look like a node, so let's just pass it as-is\n    return _createContentDigest(node)\n  }\n  return _createContentDigest({\n    ...node,\n    internal: {\n      ...node.internal,\n      // Remove auto-generated fields that'd prevent\n      // creating a consistent contentDigest.\n      contentDigest: undefined,\n      owner: undefined,\n      fieldOwners: undefined,\n      ignoreType: undefined,\n      counter: undefined,\n    },\n    fields: undefined,\n  })\n}\n\nif (!process.env.BLUEBIRD_DEBUG && !process.env.BLUEBIRD_LONG_STACK_TRACES) {\n  // Unless specified - disable longStackTraces\n  // as this have severe perf penalty ( http://bluebirdjs.com/docs/api/promise.longstacktraces.html )\n  // This is mainly for `gatsby develop` due to NODE_ENV being set to development\n  // which cause bluebird to enable longStackTraces\n  // `gatsby build` (with NODE_ENV=production) already doesn't enable longStackTraces\n  Promise.config({ longStackTraces: false })\n}\n\nconst nodeMutationsWrappers = {\n  getNode(id) {\n    return wrapNode(getNode(id))\n  },\n  getNodes() {\n    return wrapNodes(getNodes())\n  },\n  getNodesByType(type) {\n    return wrapNodes(getNodesByType(type))\n  },\n  getNodeAndSavePathDependency(id) {\n    return wrapNode(getNodeAndSavePathDependency(id))\n  },\n}\n\n// Bind action creators per plugin so we can auto-add\n// metadata to actions they create.\nconst boundPluginActionCreators = {}\nconst doubleBind = (boundActionCreators, api, plugin, actionOptions) => {\n  const { traceId, deferNodeMutation } = actionOptions\n  const defer = deferNodeMutation ? `defer-node-mutation` : ``\n  const actionKey = plugin.name + api + traceId + defer\n  if (boundPluginActionCreators[actionKey]) {\n    return boundPluginActionCreators[actionKey]\n  } else {\n    const keys = Object.keys(boundActionCreators)\n    const doubleBoundActionCreators = {}\n    for (let i = 0; i < keys.length; i++) {\n      const key = keys[i]\n      const boundActionCreator = boundActionCreators[key]\n      if (typeof boundActionCreator === `function`) {\n        doubleBoundActionCreators[key] = (...args) => {\n          if (args.length === 0) {\n            return boundActionCreator(plugin, actionOptions)\n          }\n          // Let action callers override who the plugin is. Shouldn't be\n          // used that often.\n          else if (args.length === 1) {\n            return boundActionCreator(args[0], plugin, actionOptions)\n          } else if (args.length === 2) {\n            return boundActionCreator(args[0], args[1], actionOptions)\n          }\n\n          reportOnce(\n            `Unhandled redux action: ${key}, in plugin: ${plugin.name}`\n          )\n\n          return undefined\n        }\n      }\n    }\n    boundPluginActionCreators[actionKey] = doubleBoundActionCreators\n    return doubleBoundActionCreators\n  }\n}\n\nconst initAPICallTracing = parentSpan => {\n  const startSpan = (spanName, spanArgs = {}) => {\n    const defaultSpanArgs = { childOf: parentSpan }\n\n    return tracer.startSpan(spanName, _.merge(defaultSpanArgs, spanArgs))\n  }\n\n  return {\n    tracer,\n    parentSpan,\n    startSpan,\n  }\n}\n\nconst deferredAction =\n  type =>\n  (...args) => {\n    // Regular createNode returns a Promise, but when deferred we need\n    // to wrap it in another which we resolve when it's actually called\n    if (type === `createNode`) {\n      return new Promise(resolve => {\n        emitter.emit(`ENQUEUE_NODE_MUTATION`, {\n          type,\n          payload: args,\n          resolve,\n        })\n      })\n    }\n    return emitter.emit(`ENQUEUE_NODE_MUTATION`, {\n      type,\n      payload: args,\n    })\n  }\n\nconst NODE_MUTATION_ACTIONS = [\n  `createNode`,\n  `deleteNode`,\n  `touchNode`,\n  `createParentChildLink`,\n  `createNodeField`,\n]\n\nconst deferActions = actions => {\n  const deferred = { ...actions }\n  NODE_MUTATION_ACTIONS.forEach(action => {\n    deferred[action] = deferredAction(action)\n  })\n  return deferred\n}\n\n/**\n * Create a local reporter\n * Used to override reporter methods with activity methods\n */\nfunction getLocalReporter({ activity, reporter }) {\n  // If we have an activity, bind panicOnBuild to the activities method to\n  // join them\n  if (activity) {\n    return { ...reporter, panicOnBuild: activity.panicOnBuild.bind(activity) }\n  }\n\n  return reporter\n}\n\nfunction getErrorMapWithPluginName(pluginName, errorMap) {\n  const entries = Object.entries(errorMap)\n\n  return entries.reduce((memo, [key, val]) => {\n    memo[`${pluginName}_${key}`] = val\n\n    return memo\n  }, {})\n}\n\nfunction extendLocalReporterToCatchPluginErrors({\n  reporter,\n  pluginName,\n  runningActivities,\n}) {\n  let setErrorMap\n\n  let error = reporter.error\n  let panic = reporter.panic\n  let panicOnBuild = reporter.panicOnBuild\n\n  if (pluginName && reporter?.setErrorMap) {\n    setErrorMap = errorMap =>\n      reporter.setErrorMap(getErrorMapWithPluginName(pluginName, errorMap))\n\n    error = (errorMeta, error) => {\n      reporter.error(errorMeta, error, pluginName)\n    }\n\n    panic = (errorMeta, error) => {\n      reporter.panic(errorMeta, error, pluginName)\n    }\n\n    panicOnBuild = (errorMeta, error) => {\n      reporter.panicOnBuild(errorMeta, error, pluginName)\n    }\n  }\n\n  return {\n    ...reporter,\n    setErrorMap,\n    error,\n    panic,\n    panicOnBuild,\n    // If you change arguments here, update reporter.ts as well\n    activityTimer: (text, activityArgs = {}) => {\n      let args = [text, activityArgs]\n\n      if (pluginName && setErrorMap) {\n        args = [...args, pluginName]\n      }\n\n      // eslint-disable-next-line prefer-spread\n      const activity = reporter.activityTimer.apply(reporter, args)\n\n      const originalStart = activity.start\n      const originalEnd = activity.end\n\n      activity.start = () => {\n        originalStart.apply(activity)\n        runningActivities.add(activity)\n      }\n\n      activity.end = () => {\n        originalEnd.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      return activity\n    },\n    // If you change arguments here, update reporter.ts as well\n    createProgress: (text, total = 0, start = 0, activityArgs = {}) => {\n      let args = [text, total, start, activityArgs]\n\n      if (pluginName && setErrorMap) {\n        args = [...args, pluginName]\n      }\n\n      // eslint-disable-next-line prefer-spread\n      const activity = reporter.createProgress.apply(reporter, args)\n\n      const originalStart = activity.start\n      const originalEnd = activity.end\n      const originalDone = activity.done\n\n      activity.start = () => {\n        originalStart.apply(activity)\n        runningActivities.add(activity)\n      }\n\n      activity.end = () => {\n        originalEnd.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      activity.done = () => {\n        originalDone.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      return activity\n    },\n  }\n}\n\nconst getUninitializedCache = plugin => {\n  const message =\n    `Usage of \"cache\" instance in \"onPreInit\" API is not supported as ` +\n    `this API runs before cache initialization` +\n    (plugin && plugin !== `default-site-plugin` ? ` (called in ${plugin})` : ``)\n\n  return {\n    // GatsbyCache\n    async get() {\n      throw new Error(message)\n    },\n    async set() {\n      throw new Error(message)\n    },\n    async del() {\n      throw new Error(message)\n    },\n  }\n}\n\nconst availableActionsCache = new Map()\nlet publicPath\nconst runAPI = async (plugin, api, args, activity) => {\n  const gatsbyNode = await importGatsbyPlugin(plugin, `gatsby-node`)\n\n  if (gatsbyNode[api]) {\n    const parentSpan = args && args.parentSpan\n    const spanOptions = parentSpan ? { childOf: parentSpan } : {}\n    const pluginSpan = tracer.startSpan(`run-plugin`, spanOptions)\n\n    pluginSpan.setTag(`api`, api)\n    pluginSpan.setTag(`plugin`, plugin.name)\n    const {\n      publicActions,\n      restrictedActionsAvailableInAPI,\n    } = require(`../redux/actions`)\n\n    let availableActions\n    if (availableActionsCache.has(api)) {\n      availableActions = availableActionsCache.get(api)\n    } else {\n      availableActions = {\n        ...publicActions,\n        ...(restrictedActionsAvailableInAPI[api] || {}),\n      }\n\n      availableActionsCache.set(api, availableActions)\n    }\n\n    let boundActionCreators = bindActionCreators(\n      availableActions,\n      store.dispatch\n    )\n\n    if (args.deferNodeMutation) {\n      boundActionCreators = deferActions(boundActionCreators)\n    }\n\n    const doubleBoundActionCreators = doubleBind(\n      boundActionCreators,\n      api,\n      plugin,\n      { ...args, parentSpan: pluginSpan, activity }\n    )\n\n    const { config, program } = store.getState()\n\n    const pathPrefix = (program.prefixPaths && config.pathPrefix) || ``\n\n    if (typeof publicPath === `undefined`) {\n      publicPath = getPublicPath({ ...config, ...program }, ``)\n    }\n\n    const namespacedCreateNodeId = id => createNodeId(id, plugin.name)\n\n    const tracing = initAPICallTracing(pluginSpan)\n\n    // See https://github.com/gatsbyjs/gatsby/issues/11369\n    const cache =\n      api === `onPreInit`\n        ? getUninitializedCache(plugin.name)\n        : getCache(plugin.name)\n\n    // Ideally this would be more abstracted and applied to more situations, but right now\n    // this can be potentially breaking so targeting `createPages` API and `createPage` action\n    let actions = doubleBoundActionCreators\n    let apiFinished = false\n    if (api === `createPages`) {\n      let alreadyDisplayed = false\n      const createPageAction = actions.createPage\n      // create new actions object with wrapped createPage action\n      // doubleBoundActionCreators is memoized, so we can't just\n      // reassign createPage field as this would cause this extra logic\n      // to be used in subsequent APIs and we only want to target this `createPages` call.\n      actions = {\n        ...actions,\n        createPage: (...args) => {\n          createPageAction(...args)\n          if (apiFinished && !alreadyDisplayed) {\n            const warning = [\n              reporter.stripIndent(`\n              Action ${chalk.bold(\n                `createPage`\n              )} was called outside of its expected asynchronous lifecycle ${chalk.bold(\n                `createPages`\n              )} in ${chalk.bold(plugin.name)}.\n              Ensure that you return a Promise from ${chalk.bold(\n                `createPages`\n              )} and are awaiting any asynchronous method invocations (like ${chalk.bold(\n                `graphql`\n              )} or http requests).\n              For more info and debugging tips: see ${chalk.bold(\n                `https://gatsby.dev/sync-actions`\n              )}\n            `),\n            ]\n\n            const possiblyCodeFrame = getNonGatsbyCodeFrameFormatted()\n            if (possiblyCodeFrame) {\n              warning.push(possiblyCodeFrame)\n            }\n\n            reporter.warn(warning.join(`\\n\\n`))\n            alreadyDisplayed = true\n          }\n        },\n      }\n    }\n\n    const localReporter = getLocalReporter({ activity, reporter })\n\n    const runningActivities = new Set()\n\n    const extendedLocalReporter = extendLocalReporterToCatchPluginErrors({\n      reporter: localReporter,\n      pluginName: plugin.name,\n      runningActivities,\n    })\n\n    const endInProgressActivitiesCreatedByThisRun = () => {\n      runningActivities.forEach(activity => activity.end())\n    }\n\n    const shouldDetectNodeMutations = [\n      `sourceNodes`,\n      `onCreateNode`,\n      `createResolvers`,\n      `createSchemaCustomization`,\n      `setFieldsOnGraphQLNodeType`,\n    ].includes(api)\n\n    const apiCallArgs = [\n      {\n        ...args,\n        parentSpan: pluginSpan,\n        basePath: pathPrefix,\n        pathPrefix: publicPath,\n        actions,\n        loadNodeContent,\n        store,\n        emitter,\n        getCache,\n        getNodes: shouldDetectNodeMutations\n          ? nodeMutationsWrappers.getNodes\n          : getNodes,\n        getNode: shouldDetectNodeMutations\n          ? nodeMutationsWrappers.getNode\n          : getNode,\n        getNodesByType: shouldDetectNodeMutations\n          ? nodeMutationsWrappers.getNodesByType\n          : getNodesByType,\n        reporter: extendedLocalReporter,\n        getNodeAndSavePathDependency: shouldDetectNodeMutations\n          ? nodeMutationsWrappers.getNodeAndSavePathDependency\n          : getNodeAndSavePathDependency,\n        cache,\n        createNodeId: namespacedCreateNodeId,\n        createContentDigest,\n        tracing,\n        schema: {\n          buildObjectType,\n          buildUnionType,\n          buildInterfaceType,\n          buildInputObjectType,\n          buildEnumType,\n          buildScalarType,\n        },\n      },\n      plugin.pluginOptions,\n    ]\n\n    // If the plugin is using a callback use that otherwise\n    // expect a Promise to be returned.\n    if (gatsbyNode[api].length === 3) {\n      return Promise.fromCallback(callback => {\n        const cb = (err, val) => {\n          pluginSpan.finish()\n          apiFinished = true\n          endInProgressActivitiesCreatedByThisRun()\n          callback(err, val)\n        }\n\n        try {\n          gatsbyNode[api](...apiCallArgs, cb)\n        } catch (e) {\n          trackBuildError(api, {\n            error: e,\n            pluginName: `${plugin.name}@${plugin.version}`,\n          })\n          throw e\n        }\n      })\n    } else {\n      try {\n        return await gatsbyNode[api](...apiCallArgs)\n      } finally {\n        pluginSpan.finish()\n        apiFinished = true\n        endInProgressActivitiesCreatedByThisRun()\n      }\n    }\n  }\n\n  return null\n}\n\nconst apisRunningById = new Map()\nconst apisRunningByTraceId = new Map()\nlet waitingForCasacadeToFinish = []\n\nfunction apiRunnerNode(api, args = {}, { pluginSource, activity } = {}) {\n  const plugins = store.getState().flattenedPlugins\n\n  // Get the list of plugins that implement this API.\n  // Also: Break infinite loops. Sometimes a plugin will implement an API and\n  // call an action which will trigger the same API being called.\n  // `onCreatePage` is the only example right now. In these cases, we should\n  // avoid calling the originating plugin again.\n  let implementingPlugins = plugins.filter(\n    plugin => plugin.nodeAPIs.includes(api) && plugin.name !== pluginSource\n  )\n\n  if (api === `sourceNodes` && args.pluginName) {\n    implementingPlugins = implementingPlugins.filter(\n      plugin => plugin.name === args.pluginName\n    )\n  }\n\n  // If there's no implementing plugins, return early.\n  if (implementingPlugins.length === 0) {\n    return null\n  }\n\n  return new Promise(resolve => {\n    const { parentSpan, traceId, traceTags, waitForCascadingActions } = args\n    const apiSpanArgs = parentSpan ? { childOf: parentSpan } : {}\n    const apiSpan = tracer.startSpan(`run-api`, apiSpanArgs)\n\n    apiSpan.setTag(`api`, api)\n    _.forEach(traceTags, (value, key) => {\n      apiSpan.setTag(key, value)\n    })\n\n    const apiRunInstance = {\n      api,\n      args,\n      pluginSource,\n      resolve,\n      span: apiSpan,\n      startTime: new Date().toJSON(),\n      traceId,\n    }\n\n    // Generate IDs for api runs. Most IDs we generate from the args\n    // but some API calls can have very large argument objects so we\n    // have special ways of generating IDs for those to avoid stringifying\n    // large objects.\n    let id\n    if (api === `setFieldsOnGraphQLNodeType`) {\n      id = `${api}${apiRunInstance.startTime}${args.type.name}${traceId}`\n    } else if (api === `onCreateNode`) {\n      id = `${api}${apiRunInstance.startTime}${args.node.internal.contentDigest}${traceId}`\n    } else if (api === `preprocessSource`) {\n      id = `${api}${apiRunInstance.startTime}${args.filename}${traceId}`\n    } else if (api === `onCreatePage`) {\n      id = `${api}${apiRunInstance.startTime}${args.page.path}${traceId}`\n    } else {\n      // When tracing is turned on, the `args` object will have a\n      // `parentSpan` field that can be quite large. So we omit it\n      // before calling stringify\n      const argsJson = JSON.stringify(_.omit(args, `parentSpan`))\n      id = `${api}|${apiRunInstance.startTime}|${apiRunInstance.traceId}|${argsJson}`\n    }\n    apiRunInstance.id = id\n\n    if (waitForCascadingActions) {\n      waitingForCasacadeToFinish.push(apiRunInstance)\n    }\n\n    if (apisRunningById.size === 0) {\n      emitter.emit(`API_RUNNING_START`)\n    }\n\n    apisRunningById.set(apiRunInstance.id, apiRunInstance)\n    if (apisRunningByTraceId.has(apiRunInstance.traceId)) {\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount + 1)\n    } else {\n      apisRunningByTraceId.set(apiRunInstance.traceId, 1)\n    }\n\n    let stopQueuedApiRuns = false\n    let onAPIRunComplete = null\n    if (api === `onCreatePage`) {\n      const path = args.page.path\n      const actionHandler = action => {\n        if (action.payload.path === path) {\n          stopQueuedApiRuns = true\n        }\n      }\n      emitter.on(`DELETE_PAGE`, actionHandler)\n      onAPIRunComplete = () => {\n        emitter.off(`DELETE_PAGE`, actionHandler)\n      }\n    }\n\n    let apiRunPromiseOptions = {}\n    let runPromise\n    if (\n      api === `sourceNodes` &&\n      process.env.GATSBY_EXPERIMENTAL_PARALLEL_SOURCING\n    ) {\n      runPromise = Promise.map\n      apiRunPromiseOptions.concurrency = 20\n    } else {\n      runPromise = Promise.mapSeries\n      apiRunPromiseOptions = undefined\n    }\n\n    runPromise(\n      implementingPlugins,\n      plugin => {\n        if (stopQueuedApiRuns) {\n          return null\n        }\n\n        return importGatsbyPlugin(plugin, `gatsby-node`).then(gatsbyNode => {\n          const pluginName =\n            plugin.name === `default-site-plugin`\n              ? `gatsby-node.js`\n              : plugin.name\n\n          // TODO: rethink createNode API to handle this better\n          if (\n            api === `onCreateNode` &&\n            gatsbyNode?.shouldOnCreateNode && // Don't bail if this api is not exported\n            !gatsbyNode.shouldOnCreateNode(\n              { node: args.node },\n              plugin.pluginOptions\n            )\n          ) {\n            // Do not try to schedule an async event for this node for this plugin\n            return null\n          }\n\n          return new Promise(resolve => {\n            resolve(\n              runAPI(plugin, api, { ...args, parentSpan: apiSpan }, activity)\n            )\n          }).catch(err => {\n            decorateEvent(`BUILD_PANIC`, {\n              pluginName: `${plugin.name}@${plugin.version}`,\n            })\n\n            const localReporter = getLocalReporter({ activity, reporter })\n\n            const file = stackTrace\n              .parse(err)\n              .find(file => /gatsby-node/.test(file.fileName))\n\n            let codeFrame = ``\n            const structuredError = errorParser({ err })\n\n            if (file) {\n              const { fileName, lineNumber: line, columnNumber: column } = file\n              const trimmedFileName = fileName.match(/^(async )?(.*)/)[2]\n\n              try {\n                const code = fs.readFileSync(trimmedFileName, {\n                  encoding: `utf-8`,\n                })\n                codeFrame = codeFrameColumns(\n                  code,\n                  {\n                    start: {\n                      line,\n                      column,\n                    },\n                  },\n                  {\n                    highlightCode: true,\n                  }\n                )\n              } catch (_e) {\n                // sometimes stack trace point to not existing file\n                // particularly when file is transpiled and path actually changes\n                // (like pointing to not existing `src` dir or original typescript file)\n              }\n\n              structuredError.location = {\n                start: { line: line, column: column },\n              }\n              structuredError.filePath = fileName\n            }\n\n            structuredError.context = {\n              ...structuredError.context,\n              pluginName,\n              api,\n              codeFrame,\n            }\n\n            localReporter.panicOnBuild(structuredError)\n\n            return null\n          })\n        })\n      },\n      apiRunPromiseOptions\n    ).then(results => {\n      if (onAPIRunComplete) {\n        onAPIRunComplete()\n      }\n      // Remove runner instance\n      apisRunningById.delete(apiRunInstance.id)\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount - 1)\n\n      if (apisRunningById.size === 0) {\n        emitter.emit(`API_RUNNING_QUEUE_EMPTY`)\n      }\n\n      // Filter empty results\n      apiRunInstance.results = results.filter(result => !_.isEmpty(result))\n\n      // Filter out empty responses and return if the\n      // api caller isn't waiting for cascading actions to finish.\n      if (!waitForCascadingActions) {\n        apiSpan.finish()\n        resolve(apiRunInstance.results)\n      }\n\n      // Check if any of our waiters are done.\n      waitingForCasacadeToFinish = waitingForCasacadeToFinish.filter(\n        instance => {\n          // If none of its trace IDs are running, it's done.\n          const apisByTraceIdCount = apisRunningByTraceId.get(instance.traceId)\n          if (apisByTraceIdCount === 0) {\n            instance.span.finish()\n            instance.resolve(instance.results)\n            return false\n          } else {\n            return true\n          }\n        }\n      )\n      return\n    })\n  })\n}\n\nmodule.exports = apiRunnerNode\n"],"mappings":"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"}