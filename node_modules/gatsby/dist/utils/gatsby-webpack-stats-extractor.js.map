{"version":3,"file":"gatsby-webpack-stats-extractor.js","names":["previousChunkMapJson","previousWebpackStatsJson","GatsbyWebpackStatsExtractor","constructor","publicPath","plugin","name","apply","compiler","hooks","done","tapAsync","stats","assets","assetsMap","childAssets","chunkGroup","compilation","chunkGroups","files","chunk","chunks","chunkReason","PARTIAL_HYDRATION_CHUNK_REASON","push","filter","f","slice","length","map","filename","rel","childChunkGroups","Object","entries","getChildrenByOrders","moduleGraph","chunkGraph","childFiles","childChunkGroup","namedChunkGroups","assetsRelatedStats","toJson","all","cachedAssets","webpackStats","assetsByChunkName","childAssetsByChunkName","Set","asset","add","info","related","relatedAssets","values","Array","isArray","relatedAsset","setWebpackAssets","newChunkMapJson","JSON","stringify","fs","writeFile","path","join","process","env","GATSBY_SLICES","scriptChunkMapping","chunkSliceContents","ensureDir","hashSliceContents","hash","assetSliceContents","polyfill","endsWith","app","scriptsSliceHtmlChanged","ensureFileContent","store","dispatch","type","newWebpackStatsJson"],"sources":["../../src/utils/gatsby-webpack-stats-extractor.ts"],"sourcesContent":["import fs from \"fs-extra\"\nimport path from \"path\"\nimport { Compiler } from \"webpack\"\nimport { PARTIAL_HYDRATION_CHUNK_REASON } from \"./webpack/plugins/partial-hydration\"\nimport { store } from \"../redux\"\nimport { ensureFileContent } from \"./ensure-file-content\"\nimport { setWebpackAssets } from \"./adapter/manager\"\n\nlet previousChunkMapJson: string | undefined\nlet previousWebpackStatsJson: string | undefined\n\nexport class GatsbyWebpackStatsExtractor {\n  private plugin: { name: string }\n  private publicPath: string\n\n  constructor(publicPath: string) {\n    this.plugin = { name: `GatsbyWebpackStatsExtractor` }\n    this.publicPath = publicPath\n  }\n  apply(compiler: Compiler): void {\n    compiler.hooks.done.tapAsync(this.plugin.name, async (stats, done) => {\n      const assets: { [key: string]: Array<string> } = {}\n      const assetsMap = {}\n      const childAssets = {}\n      for (const chunkGroup of stats.compilation.chunkGroups) {\n        if (chunkGroup.name) {\n          const files: Array<string> = []\n          for (const chunk of chunkGroup.chunks) {\n            if (chunk.chunkReason !== PARTIAL_HYDRATION_CHUNK_REASON) {\n              files.push(...chunk.files)\n            }\n          }\n          assets[chunkGroup.name] = files.filter(f => f.slice(-4) !== `.map`)\n          assetsMap[chunkGroup.name] = files\n            .filter(\n              f =>\n                f.slice(-4) !== `.map` &&\n                f.slice(0, chunkGroup.name?.length) === chunkGroup.name\n            )\n            .map(filename => `/${filename}`)\n\n          for (const [rel, childChunkGroups] of Object.entries(\n            chunkGroup.getChildrenByOrders(\n              stats.compilation.moduleGraph,\n              stats.compilation.chunkGraph\n            )\n          )) {\n            if (!(chunkGroup.name in childAssets)) {\n              childAssets[chunkGroup.name] = {}\n            }\n\n            const childFiles: Array<string> = []\n            for (const childChunkGroup of childChunkGroups) {\n              for (const chunk of childChunkGroup.chunks) {\n                childFiles.push(...chunk.files)\n              }\n            }\n\n            childAssets[chunkGroup.name][rel] = childFiles\n          }\n        }\n      }\n\n      const {\n        namedChunkGroups = {},\n        name = ``,\n        ...assetsRelatedStats\n      } = stats.toJson({\n        all: false,\n        chunkGroups: true,\n        cachedAssets: true,\n        assets: true,\n      })\n\n      const webpackStats = {\n        name,\n        namedChunkGroups,\n        assetsByChunkName: assets,\n        childAssetsByChunkName: childAssets,\n      }\n\n      if (assetsRelatedStats.assets) {\n        const assets = new Set<string>()\n        for (const asset of assetsRelatedStats.assets) {\n          assets.add(asset.name)\n\n          if (asset.info.related) {\n            for (const relatedAssets of Object.values(asset.info.related)) {\n              if (Array.isArray(relatedAssets)) {\n                for (const relatedAsset of relatedAssets) {\n                  assets.add(relatedAsset)\n                }\n              } else {\n                assets.add(relatedAssets)\n              }\n            }\n          }\n        }\n        setWebpackAssets(assets)\n      }\n\n      const newChunkMapJson = JSON.stringify(assetsMap)\n      if (newChunkMapJson !== previousChunkMapJson) {\n        await fs.writeFile(\n          path.join(`public`, `chunk-map.json`),\n          newChunkMapJson\n        )\n\n        if (_CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_SLICES) {\n          // Add chunk mapping metadata to scripts slice\n          const scriptChunkMapping = `window.___chunkMapping=${JSON.stringify(\n            newChunkMapJson\n          )};`\n\n          const chunkSliceContents = `\n          <script\n            id=\"gatsby-chunk-mapping\"\n          >\n            ${scriptChunkMapping}\n          </script>\n        `\n\n          await fs.ensureDir(path.join(`public`, `_gatsby`, `slices`))\n\n          const hashSliceContents = `<script>window.___webpackCompilationHash=\"${stats.hash}\";</script>`\n\n          const assetSliceContents: Array<string> = []\n\n          if (`polyfill` in assets && assets.polyfill) {\n            for (const asset of assets.polyfill) {\n              if (asset.endsWith(`.js`)) {\n                assetSliceContents.push(\n                  `<script src=\"${this.publicPath}/${asset}\" nomodule></script>`\n                )\n              }\n            }\n          }\n\n          if (`app` in assets && assets.app) {\n            for (const asset of assets.app) {\n              if (asset.endsWith(`.js`)) {\n                assetSliceContents.push(\n                  `<script src=\"${this.publicPath}/${asset}\" async></script>`\n                )\n              }\n            }\n          }\n\n          const scriptsSliceHtmlChanged = await ensureFileContent(\n            path.join(`public`, `_gatsby`, `slices`, `_gatsby-scripts-1.html`),\n            chunkSliceContents + hashSliceContents + assetSliceContents.join(``)\n          )\n\n          if (scriptsSliceHtmlChanged) {\n            store.dispatch({\n              type: `SLICES_SCRIPTS_REGENERATED`,\n            })\n          }\n        }\n\n        previousChunkMapJson = newChunkMapJson\n      }\n\n      const newWebpackStatsJson = JSON.stringify(webpackStats)\n      if (newWebpackStatsJson !== previousWebpackStatsJson) {\n        await fs.writeFile(\n          path.join(`public`, `webpack.stats.json`),\n          newWebpackStatsJson\n        )\n        previousWebpackStatsJson = newWebpackStatsJson\n      }\n\n      done()\n    })\n  }\n}\n"],"mappings":";;;;;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA,IAAIA,oBAAwC;AAC5C,IAAIC,wBAA4C;AAEzC,MAAMC,2BAA2B,CAAC;EAIvCC,WAAW,CAACC,UAAkB,EAAE;IAC9B,IAAI,CAACC,MAAM,GAAG;MAAEC,IAAI,EAAG;IAA6B,CAAC;IACrD,IAAI,CAACF,UAAU,GAAGA,UAAU;EAC9B;EACAG,KAAK,CAACC,QAAkB,EAAQ;IAC9BA,QAAQ,CAACC,KAAK,CAACC,IAAI,CAACC,QAAQ,CAAC,IAAI,CAACN,MAAM,CAACC,IAAI,EAAE,OAAOM,KAAK,EAAEF,IAAI,KAAK;MACpE,MAAMG,MAAwC,GAAG,CAAC,CAAC;MACnD,MAAMC,SAAS,GAAG,CAAC,CAAC;MACpB,MAAMC,WAAW,GAAG,CAAC,CAAC;MACtB,KAAK,MAAMC,UAAU,IAAIJ,KAAK,CAACK,WAAW,CAACC,WAAW,EAAE;QACtD,IAAIF,UAAU,CAACV,IAAI,EAAE;UACnB,MAAMa,KAAoB,GAAG,EAAE;UAC/B,KAAK,MAAMC,KAAK,IAAIJ,UAAU,CAACK,MAAM,EAAE;YACrC,IAAID,KAAK,CAACE,WAAW,KAAKC,gDAA8B,EAAE;cACxDJ,KAAK,CAACK,IAAI,CAAC,GAAGJ,KAAK,CAACD,KAAK,CAAC;YAC5B;UACF;UACAN,MAAM,CAACG,UAAU,CAACV,IAAI,CAAC,GAAGa,KAAK,CAACM,MAAM,CAACC,CAAC,IAAIA,CAAC,CAACC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAM,MAAK,CAAC;UACnEb,SAAS,CAACE,UAAU,CAACV,IAAI,CAAC,GAAGa,KAAK,CAC/BM,MAAM,CACLC,CAAC;YAAA;YAAA,OACCA,CAAC,CAACC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAM,MAAK,IACtBD,CAAC,CAACC,KAAK,CAAC,CAAC,sBAAEX,UAAU,CAACV,IAAI,qDAAf,iBAAiBsB,MAAM,CAAC,KAAKZ,UAAU,CAACV,IAAI;UAAA,EAC1D,CACAuB,GAAG,CAACC,QAAQ,IAAK,IAAGA,QAAS,EAAC,CAAC;UAElC,KAAK,MAAM,CAACC,GAAG,EAAEC,gBAAgB,CAAC,IAAIC,MAAM,CAACC,OAAO,CAClDlB,UAAU,CAACmB,mBAAmB,CAC5BvB,KAAK,CAACK,WAAW,CAACmB,WAAW,EAC7BxB,KAAK,CAACK,WAAW,CAACoB,UAAU,CAC7B,CACF,EAAE;YACD,IAAI,EAAErB,UAAU,CAACV,IAAI,IAAIS,WAAW,CAAC,EAAE;cACrCA,WAAW,CAACC,UAAU,CAACV,IAAI,CAAC,GAAG,CAAC,CAAC;YACnC;YAEA,MAAMgC,UAAyB,GAAG,EAAE;YACpC,KAAK,MAAMC,eAAe,IAAIP,gBAAgB,EAAE;cAC9C,KAAK,MAAMZ,KAAK,IAAImB,eAAe,CAAClB,MAAM,EAAE;gBAC1CiB,UAAU,CAACd,IAAI,CAAC,GAAGJ,KAAK,CAACD,KAAK,CAAC;cACjC;YACF;YAEAJ,WAAW,CAACC,UAAU,CAACV,IAAI,CAAC,CAACyB,GAAG,CAAC,GAAGO,UAAU;UAChD;QACF;MACF;MAEA,MAAM;QACJE,gBAAgB,GAAG,CAAC,CAAC;QACrBlC,IAAI,GAAI,EAAC;QACT,GAAGmC;MACL,CAAC,GAAG7B,KAAK,CAAC8B,MAAM,CAAC;QACfC,GAAG,EAAE,KAAK;QACVzB,WAAW,EAAE,IAAI;QACjB0B,YAAY,EAAE,IAAI;QAClB/B,MAAM,EAAE;MACV,CAAC,CAAC;MAEF,MAAMgC,YAAY,GAAG;QACnBvC,IAAI;QACJkC,gBAAgB;QAChBM,iBAAiB,EAAEjC,MAAM;QACzBkC,sBAAsB,EAAEhC;MAC1B,CAAC;MAED,IAAI0B,kBAAkB,CAAC5B,MAAM,EAAE;QAC7B,MAAMA,MAAM,GAAG,IAAImC,GAAG,EAAU;QAChC,KAAK,MAAMC,KAAK,IAAIR,kBAAkB,CAAC5B,MAAM,EAAE;UAC7CA,MAAM,CAACqC,GAAG,CAACD,KAAK,CAAC3C,IAAI,CAAC;UAEtB,IAAI2C,KAAK,CAACE,IAAI,CAACC,OAAO,EAAE;YACtB,KAAK,MAAMC,aAAa,IAAIpB,MAAM,CAACqB,MAAM,CAACL,KAAK,CAACE,IAAI,CAACC,OAAO,CAAC,EAAE;cAC7D,IAAIG,KAAK,CAACC,OAAO,CAACH,aAAa,CAAC,EAAE;gBAChC,KAAK,MAAMI,YAAY,IAAIJ,aAAa,EAAE;kBACxCxC,MAAM,CAACqC,GAAG,CAACO,YAAY,CAAC;gBAC1B;cACF,CAAC,MAAM;gBACL5C,MAAM,CAACqC,GAAG,CAACG,aAAa,CAAC;cAC3B;YACF;UACF;QACF;QACA,IAAAK,yBAAgB,EAAC7C,MAAM,CAAC;MAC1B;MAEA,MAAM8C,eAAe,GAAGC,IAAI,CAACC,SAAS,CAAC/C,SAAS,CAAC;MACjD,IAAI6C,eAAe,KAAK3D,oBAAoB,EAAE;QAC5C,MAAM8D,gBAAE,CAACC,SAAS,CAChBC,aAAI,CAACC,IAAI,CAAE,QAAO,EAAG,gBAAe,CAAC,EACrCN,eAAe,CAChB;QAED,IAAI,QAA2B,GAAE,IAAIO,OAAO,CAACC,GAAG,CAACC,aAAa,EAAE;UAC9D;UACA,MAAMC,kBAAkB,GAAI,0BAAyBT,IAAI,CAACC,SAAS,CACjEF,eAAe,CACf,GAAE;UAEJ,MAAMW,kBAAkB,GAAI;AACtC;AACA;AACA;AACA,cAAcD,kBAAmB;AACjC;AACA,SAAS;UAEC,MAAMP,gBAAE,CAACS,SAAS,CAACP,aAAI,CAACC,IAAI,CAAE,QAAO,EAAG,SAAQ,EAAG,QAAO,CAAC,CAAC;UAE5D,MAAMO,iBAAiB,GAAI,6CAA4C5D,KAAK,CAAC6D,IAAK,aAAY;UAE9F,MAAMC,kBAAiC,GAAG,EAAE;UAE5C,IAAK,UAAS,IAAI7D,MAAM,IAAIA,MAAM,CAAC8D,QAAQ,EAAE;YAC3C,KAAK,MAAM1B,KAAK,IAAIpC,MAAM,CAAC8D,QAAQ,EAAE;cACnC,IAAI1B,KAAK,CAAC2B,QAAQ,CAAE,KAAI,CAAC,EAAE;gBACzBF,kBAAkB,CAAClD,IAAI,CACpB,gBAAe,IAAI,CAACpB,UAAW,IAAG6C,KAAM,sBAAqB,CAC/D;cACH;YACF;UACF;UAEA,IAAK,KAAI,IAAIpC,MAAM,IAAIA,MAAM,CAACgE,GAAG,EAAE;YACjC,KAAK,MAAM5B,KAAK,IAAIpC,MAAM,CAACgE,GAAG,EAAE;cAC9B,IAAI5B,KAAK,CAAC2B,QAAQ,CAAE,KAAI,CAAC,EAAE;gBACzBF,kBAAkB,CAAClD,IAAI,CACpB,gBAAe,IAAI,CAACpB,UAAW,IAAG6C,KAAM,mBAAkB,CAC5D;cACH;YACF;UACF;UAEA,MAAM6B,uBAAuB,GAAG,MAAM,IAAAC,oCAAiB,EACrDf,aAAI,CAACC,IAAI,CAAE,QAAO,EAAG,SAAQ,EAAG,QAAO,EAAG,wBAAuB,CAAC,EAClEK,kBAAkB,GAAGE,iBAAiB,GAAGE,kBAAkB,CAACT,IAAI,CAAE,EAAC,CAAC,CACrE;UAED,IAAIa,uBAAuB,EAAE;YAC3BE,YAAK,CAACC,QAAQ,CAAC;cACbC,IAAI,EAAG;YACT,CAAC,CAAC;UACJ;QACF;QAEAlF,oBAAoB,GAAG2D,eAAe;MACxC;MAEA,MAAMwB,mBAAmB,GAAGvB,IAAI,CAACC,SAAS,CAAChB,YAAY,CAAC;MACxD,IAAIsC,mBAAmB,KAAKlF,wBAAwB,EAAE;QACpD,MAAM6D,gBAAE,CAACC,SAAS,CAChBC,aAAI,CAACC,IAAI,CAAE,QAAO,EAAG,oBAAmB,CAAC,EACzCkB,mBAAmB,CACpB;QACDlF,wBAAwB,GAAGkF,mBAAmB;MAChD;MAEAzE,IAAI,EAAE;IACR,CAAC,CAAC;EACJ;AACF;AAAC"}