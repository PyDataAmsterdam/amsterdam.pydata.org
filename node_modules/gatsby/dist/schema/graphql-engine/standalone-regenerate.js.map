{"version":3,"file":"standalone-regenerate.js","names":["run","process","env","GATSBY_SLICES","reporter","verbose","loadConfigAndPlugins","siteDirectory","cwd","fs","remove","e","state","store","getState","buildActivityTimer","activityTimer","start","Promise","all","createGraphqlEngineBundle","createPageSSRBundle","rootDir","components","staticQueriesByTemplate","webpackCompilationHash","isVerbose","program","err","panic","end","validateEnginesWithActivity","info"],"sources":["../../../src/schema/graphql-engine/standalone-regenerate.ts"],"sourcesContent":["#!/usr/bin/env node\n\n/*\nThis is used mostly for development purposes, but can be attempted to be used\nto regenerate just engines for local platform/arch if previous full build\nwas done to deploy on platform with different arch/platform.\n\nFor development purposes this is used to be able to run `gatsby build` once to\nsource data and print schema and then just rebundle graphql-engine\nwith source file changes and test re-built engine quickly\n\nUsage:\nThere need to be at least one successful `gatsby build`\nbefore starting to use this script (warm up datastore,\ngenerate \"page-ssr\" bundle). Once that's done you can\nrun following command in site directory:\n\n```shell\nnode node_modules/gatsby/dist/schema/graphql-engine/standalone-regenerate.js\n```\n*/\n\nimport { createGraphqlEngineBundle } from \"./bundle-webpack\"\nimport { createPageSSRBundle } from \"./../../utils/page-ssr-module/bundle-webpack\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { loadConfigAndPlugins } from \"../../utils/worker/child/load-config-and-plugins\"\nimport * as fs from \"fs-extra\"\nimport { store } from \"../../redux\"\nimport { validateEnginesWithActivity } from \"../../utils/validate-engines\"\n\nasync function run(): Promise<void> {\n  process.env.GATSBY_SLICES = `1`\n  // load config\n  reporter.verbose(`loading config and plugins`)\n  await loadConfigAndPlugins({\n    siteDirectory: process.cwd(),\n  })\n\n  try {\n    reporter.verbose(`clearing webpack cache`)\n    // get rid of cache if it exist\n    await fs.remove(process.cwd() + `/.cache/webpack/query-engine`)\n    await fs.remove(process.cwd() + `/.cache/webpack/page-ssr`)\n  } catch (e) {\n    // eslint-disable no-empty\n  }\n\n  const state = store.getState()\n\n  // recompile\n  const buildActivityTimer = reporter.activityTimer(\n    `(Re)Building Rendering Engines`\n  )\n  try {\n    buildActivityTimer.start()\n    await Promise.all([\n      createGraphqlEngineBundle(process.cwd(), reporter, true),\n      createPageSSRBundle({\n        rootDir: process.cwd(),\n        components: store.getState().components,\n        staticQueriesByTemplate: state.staticQueriesByTemplate,\n        webpackCompilationHash: state.webpackCompilationHash, // we set webpackCompilationHash above\n        reporter,\n        isVerbose: state.program.verbose,\n      }),\n    ])\n  } catch (err) {\n    buildActivityTimer.panic(err)\n  } finally {\n    buildActivityTimer.end()\n  }\n\n  await validateEnginesWithActivity(process.cwd())\n\n  reporter.info(`Rebuilding Rendering Engines finished`)\n}\n\nrun()\n"],"mappings":"AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAlBA;;AAAA;AAoBA;AACA;AACA;AACA;AACA;AACA;AACA;AAA0E;AAAA;AAE1E,eAAeA,GAAG,GAAkB;EAClCC,OAAO,CAACC,GAAG,CAACC,aAAa,GAAI,GAAE;EAC/B;EACAC,iBAAQ,CAACC,OAAO,CAAE,4BAA2B,CAAC;EAC9C,MAAM,IAAAC,0CAAoB,EAAC;IACzBC,aAAa,EAAEN,OAAO,CAACO,GAAG;EAC5B,CAAC,CAAC;EAEF,IAAI;IACFJ,iBAAQ,CAACC,OAAO,CAAE,wBAAuB,CAAC;IAC1C;IACA,MAAMI,EAAE,CAACC,MAAM,CAACT,OAAO,CAACO,GAAG,EAAE,GAAI,8BAA6B,CAAC;IAC/D,MAAMC,EAAE,CAACC,MAAM,CAACT,OAAO,CAACO,GAAG,EAAE,GAAI,0BAAyB,CAAC;EAC7D,CAAC,CAAC,OAAOG,CAAC,EAAE;IACV;EAAA;EAGF,MAAMC,KAAK,GAAGC,YAAK,CAACC,QAAQ,EAAE;;EAE9B;EACA,MAAMC,kBAAkB,GAAGX,iBAAQ,CAACY,aAAa,CAC9C,gCAA+B,CACjC;EACD,IAAI;IACFD,kBAAkB,CAACE,KAAK,EAAE;IAC1B,MAAMC,OAAO,CAACC,GAAG,CAAC,CAChB,IAAAC,wCAAyB,EAACnB,OAAO,CAACO,GAAG,EAAE,EAAEJ,iBAAQ,EAAE,IAAI,CAAC,EACxD,IAAAiB,mCAAmB,EAAC;MAClBC,OAAO,EAAErB,OAAO,CAACO,GAAG,EAAE;MACtBe,UAAU,EAAEV,YAAK,CAACC,QAAQ,EAAE,CAACS,UAAU;MACvCC,uBAAuB,EAAEZ,KAAK,CAACY,uBAAuB;MACtDC,sBAAsB,EAAEb,KAAK,CAACa,sBAAsB;MAAE;MACtDrB,QAAQ,EAARA,iBAAQ;MACRsB,SAAS,EAAEd,KAAK,CAACe,OAAO,CAACtB;IAC3B,CAAC,CAAC,CACH,CAAC;EACJ,CAAC,CAAC,OAAOuB,GAAG,EAAE;IACZb,kBAAkB,CAACc,KAAK,CAACD,GAAG,CAAC;EAC/B,CAAC,SAAS;IACRb,kBAAkB,CAACe,GAAG,EAAE;EAC1B;EAEA,MAAM,IAAAC,4CAA2B,EAAC9B,OAAO,CAACO,GAAG,EAAE,CAAC;EAEhDJ,iBAAQ,CAAC4B,IAAI,CAAE,uCAAsC,CAAC;AACxD;AAEAhC,GAAG,EAAE"}