{"version":3,"file":"type-owners.js","names":["setTypeOwner","typeName","plugin","typeOwners","fullNode","ownerName","name","internal","owner","reportOnce","existingOwnerTypes","pluginsToTypes","get","set","Set","add","existingTypeOwnerNameByTypeName","typesToPlugins","Error","stripIndent","JSON","stringify","typeOwnersReducer","Map","action","type","payload","internalNode","isRecursiveChildrenDelete","pluginName","previouslyRecordedOwnerName","oldNode","node","id"],"sources":["../../../src/redux/reducers/type-owners.ts"],"sourcesContent":["import { stripIndent } from \"common-tags\"\nimport { reportOnce } from \"../../utils/report-once\"\nimport {\n  ActionsUnion,\n  IGatsbyNode,\n  IGatsbyPlugin,\n  IGatsbyState,\n} from \"../types\"\n\nfunction setTypeOwner(\n  typeName: string,\n  plugin: IGatsbyPlugin,\n  typeOwners: IGatsbyState[\"typeOwners\"],\n  fullNode?: IGatsbyNode\n): IGatsbyState[\"typeOwners\"] {\n  const ownerName = plugin?.name || fullNode?.internal.owner\n\n  if (!ownerName) {\n    reportOnce(`No plugin owner for type \"${typeName}\"`)\n    return typeOwners\n  }\n\n  const existingOwnerTypes = typeOwners.pluginsToTypes.get(ownerName)\n\n  if (!existingOwnerTypes) {\n    typeOwners.pluginsToTypes.set(ownerName, new Set([typeName]))\n  } else {\n    existingOwnerTypes.add(typeName)\n  }\n\n  const existingTypeOwnerNameByTypeName =\n    typeOwners.typesToPlugins.get(typeName)\n\n  if (!existingTypeOwnerNameByTypeName) {\n    typeOwners.typesToPlugins.set(typeName, ownerName)\n  } else if (existingTypeOwnerNameByTypeName !== ownerName) {\n    throw new Error(stripIndent`\n      The plugin \"${ownerName}\" created a node of a type owned by another plugin.\n\n      The node type \"${typeName}\" is owned by \"${existingTypeOwnerNameByTypeName}\".\n\n      If you copy and pasted code from elsewhere, you'll need to pick a new type name\n      for your new node(s).\n\n      ${\n        fullNode\n          ? stripIndent(\n              `The node object passed to \"createNode\":\n\n              ${JSON.stringify(fullNode, null, 4)}\\n`\n            )\n          : ``\n      }\n      The plugin creating the node:\n\n      ${JSON.stringify(plugin, null, 4)}\n    `)\n  }\n\n  return typeOwners\n}\n\nexport const typeOwnersReducer = (\n  typeOwners: IGatsbyState[\"typeOwners\"] = {\n    pluginsToTypes: new Map(),\n    typesToPlugins: new Map(),\n  } as IGatsbyState[\"typeOwners\"],\n  action: ActionsUnion\n): IGatsbyState[\"typeOwners\"] => {\n  switch (action.type) {\n    case `DELETE_NODE`: {\n      const { plugin, payload: internalNode } = action\n\n      if (plugin && internalNode && !action.isRecursiveChildrenDelete) {\n        const pluginName = plugin.name\n\n        const previouslyRecordedOwnerName = typeOwners.typesToPlugins.get(\n          internalNode.internal.type\n        )\n\n        if (\n          internalNode &&\n          previouslyRecordedOwnerName &&\n          previouslyRecordedOwnerName !== pluginName\n        ) {\n          throw new Error(stripIndent`\n            The plugin \"${pluginName}\" deleted a node of a type owned by another plugin.\n\n            The node type \"${\n              internalNode.internal.type\n            }\" is owned by \"${previouslyRecordedOwnerName}\".\n\n            The node object passed to \"deleteNode\":\n\n            ${JSON.stringify(internalNode, null, 4)}\n\n            The plugin deleting the node:\n\n            ${JSON.stringify(plugin, null, 4)}\n        `)\n        }\n      }\n\n      return typeOwners\n    }\n    case `CREATE_NODE`: {\n      const { plugin, oldNode, payload: node } = action\n      const { owner, type } = node.internal\n\n      setTypeOwner(type, plugin, typeOwners, node)\n\n      // If the node has been created in the past, check that\n      // the current plugin is the same as the previous.\n      if (oldNode && oldNode.internal.owner !== owner) {\n        throw new Error(\n          stripIndent`\n            Nodes can only be updated by their owner. Node \"${node.id}\" is\n            owned by \"${oldNode.internal.owner}\" and another plugin \"${owner}\"\n            tried to update it.\n          `\n        )\n      }\n\n      return typeOwners\n    }\n\n    default:\n      return typeOwners\n  }\n}\n"],"mappings":"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"}