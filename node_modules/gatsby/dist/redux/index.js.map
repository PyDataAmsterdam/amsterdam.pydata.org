{"version":3,"file":"index.js","names":["persistedReduxKeys","reducers","reduce","acc","key","rawReducer","rawReducers","state","action","type","payload","emitter","mett","readState","readFromCache","nodes","nodesByType","Map","forEach","node","internal","has","set","get","id","telemetry","trackCli","cacheStatus","e","multi","dispatch","next","Array","isArray","filter","Boolean","map","configureStore","initialState","store","createStore","combineReducers","applyMiddleware","thunk","process","env","GATSBY_WORKER_POOL_WORKER","replaceReducer","customReducers","saveState","GATSBY_DISABLE_CACHE_PERSISTENCE","undefined","getState","sliceOfStateToPersist","writeToCache","savePartialStateToDisk","slices","optionalPrefix","transformState","contents","savedContents","loadPartialStateFromDisk","subscribe","lastAction","emit"],"sources":["../../src/redux/index.ts"],"sourcesContent":["import {\n  applyMiddleware,\n  combineReducers,\n  createStore,\n  DeepPartial,\n  Middleware,\n  ReducersMapObject,\n  Store,\n} from \"redux\"\nimport _ from \"lodash\"\nimport telemetry from \"gatsby-telemetry\"\n\nimport { mett } from \"../utils/mett\"\nimport thunk, { ThunkMiddleware, ThunkAction, ThunkDispatch } from \"redux-thunk\"\nimport * as rawReducers from \"./reducers\"\nimport { writeToCache, readFromCache } from \"./persist\"\nimport { IGatsbyState, ActionsUnion, GatsbyStateKeys } from \"./types\"\n\nconst persistedReduxKeys = [\n  `nodes`,\n  `typeOwners`,\n  `statefulSourcePlugins`,\n  `status`,\n  `components`,\n  `jobsV2`,\n  `staticQueryComponents`,\n  `webpackCompilationHash`,\n  `pageDataStats`,\n  `pages`,\n  `staticQueriesByTemplate`,\n  `pendingPageDataWrites`,\n  `queries`,\n  `html`,\n  `slices`,\n  `slicesByTemplate`,\n]\n\nconst reducers = persistedReduxKeys.reduce((acc, key) => {\n  const rawReducer = rawReducers[key]\n  acc[key] = function (state, action): any {\n    if (action.type === `RESTORE_CACHE` && action.payload[key]) {\n      return action.payload[key]\n    } else {\n      return rawReducer(state, action)\n    }\n  }\n\n  return acc\n}, rawReducers)\n\n// Create event emitter for actions\nexport const emitter = mett()\n\n// Read old node data from cache.\nexport const readState = (): IGatsbyState => {\n  try {\n    const state = readFromCache() as IGatsbyState\n    if (state.nodes) {\n      // re-create nodesByType\n      state.nodesByType = new Map()\n      state.nodes.forEach(node => {\n        const { type } = node.internal\n        if (!state.nodesByType.has(type)) {\n          state.nodesByType.set(type, new Map())\n        }\n        // The `.has` and `.set` calls above make this safe\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n        state.nodesByType.get(type)!.set(node.id, node)\n      })\n    }\n\n    // jsonDataPaths was removed in the per-page-manifest\n    // changes. Explicitly delete it here to cover case where user\n    // runs gatsby the first time after upgrading.\n    delete state[`jsonDataPaths`]\n\n    telemetry.trackCli(`CACHE_STATUS`, {\n      cacheStatus: `WARM`,\n    })\n\n    return state\n  } catch (e) {\n    telemetry.trackCli(`CACHE_STATUS`, {\n      cacheStatus: `COLD`,\n    })\n\n    return {} as IGatsbyState\n  }\n}\n\nexport interface IMultiDispatch {\n  <T extends ActionsUnion | ThunkAction<any, IGatsbyState, any, ActionsUnion>>(\n    action: Array<T>\n  ): Array<T>\n}\n\n/**\n * Redux middleware handling array of actions\n */\nconst multi: Middleware<IMultiDispatch> =\n  ({ dispatch }) =>\n  next =>\n  (action: ActionsUnion): ActionsUnion | Array<ActionsUnion> =>\n    Array.isArray(action) ? action.filter(Boolean).map(dispatch) : next(action)\n\nexport type GatsbyReduxStore = Store<IGatsbyState> & {\n  dispatch: ThunkDispatch<IGatsbyState, any, ActionsUnion> & IMultiDispatch\n}\n\nexport const configureStore = (\n  initialState: IGatsbyState\n): GatsbyReduxStore => {\n  const store = createStore(\n    combineReducers<IGatsbyState>({ ...reducers }),\n    initialState,\n    applyMiddleware(thunk as ThunkMiddleware<IGatsbyState, ActionsUnion>, multi)\n  )\n\n  store.dispatch({\n    type: `INIT`,\n  })\n\n  return store\n}\n\nexport const store: GatsbyReduxStore = configureStore(\n  process.env.GATSBY_WORKER_POOL_WORKER ? ({} as IGatsbyState) : readState()\n)\n\n/**\n * Allows overloading some reducers (e.g. when setting a custom datastore)\n */\nexport function replaceReducer(\n  customReducers: Partial<ReducersMapObject<IGatsbyState>>\n): void {\n  store.replaceReducer(\n    combineReducers<IGatsbyState>({ ...reducers, ...customReducers })\n  )\n}\n\n// Persist state.\nexport const saveState = (): void => {\n  if (process.env.GATSBY_DISABLE_CACHE_PERSISTENCE) {\n    // do not persist cache if above env var is set.\n    // this is to temporarily unblock builds that hit the v8.serialize related\n    // Node.js buffer size exceeding kMaxLength fatal crashes\n    return undefined\n  }\n\n  const state = store.getState()\n\n  const sliceOfStateToPersist = _.pick(state, persistedReduxKeys)\n\n  return writeToCache(sliceOfStateToPersist)\n}\n\nexport const savePartialStateToDisk = (\n  slices: Array<GatsbyStateKeys>,\n  optionalPrefix?: string,\n  transformState?: <T extends DeepPartial<IGatsbyState>>(state: T) => T\n): void => {\n  const state = store.getState()\n  const contents = _.pick(state, slices)\n  const savedContents = transformState ? transformState(contents) : contents\n\n  return writeToCache(savedContents, slices, optionalPrefix)\n}\n\nexport const loadPartialStateFromDisk = (\n  slices: Array<GatsbyStateKeys>,\n  optionalPrefix?: string\n): DeepPartial<IGatsbyState> => {\n  try {\n    return readFromCache(slices, optionalPrefix) as DeepPartial<IGatsbyState>\n  } catch (e) {\n    // ignore errors.\n  }\n  return {} as IGatsbyState\n}\n\nstore.subscribe(() => {\n  const lastAction = store.getState().lastAction\n  emitter.emit(lastAction.type, lastAction)\n})\n"],"mappings":"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"}