{"version":3,"file":"head-export-handler-for-ssr.js","names":["React","require","grabMatchParams","StaticQueryContext","headExportValidator","filterHeadProps","isElementType","isValidNodeName","warnForInvalidTag","ServerLocation","Router","renderToString","parse","styleToOjbect","applyHtmlAndBodyAttributesSSR","htmlAndBodyAttributes","setHtmlAttributes","setBodyAttributes","html","body","getValidHeadNodesAndAttributesSSR","rootNode","seenIds","Map","validHeadNodes","node","childNodes","rawTagName","id","attributes","style","nonStyleAttributes","element","__html","text","textContent","length","has","push","set","indexOfPreviouslyInsertedNode","get","headHandlerForSSR","pageComponent","setHeadComponents","staticQueryContext","pageData","pagePath","Head","HeadRouteHandler","props","_props","result","params","location","pathname","pageContext","__params","HeadElement","headWithWrapRootElement","apiRunner","pop","routerElement","__BASE_PATH__","children","rawString"],"sources":["../../head/head-export-handler-for-ssr.js"],"sourcesContent":["const React = require(`react`)\nconst { grabMatchParams } = require(`../find-path`)\nconst { StaticQueryContext } = require(`gatsby`)\nconst {\n  headExportValidator,\n  filterHeadProps,\n  isElementType,\n  isValidNodeName,\n  warnForInvalidTag,\n} = require(`./utils`)\nconst { ServerLocation, Router } = require(`@gatsbyjs/reach-router`)\nconst { renderToString } = require(`react-dom/server`)\nconst { parse } = require(`node-html-parser`)\nconst styleToOjbect = require(`style-to-object`)\nimport { apiRunner } from \"../api-runner-ssr\"\n\nexport function applyHtmlAndBodyAttributesSSR(\n  htmlAndBodyAttributes,\n  { setHtmlAttributes, setBodyAttributes }\n) {\n  if (!htmlAndBodyAttributes) return\n\n  const { html, body } = htmlAndBodyAttributes\n\n  setHtmlAttributes(html)\n  setBodyAttributes(body)\n}\n\nexport function getValidHeadNodesAndAttributesSSR(\n  rootNode,\n  htmlAndBodyAttributes = {\n    html: {},\n    body: {},\n  }\n) {\n  const seenIds = new Map()\n  const validHeadNodes = []\n\n  // Filter out non-element nodes before looping since we don't care about them\n  for (const node of rootNode.childNodes) {\n    const { rawTagName } = node\n    const id = node.attributes?.id\n\n    if (!isElementType(node)) continue\n\n    if (isValidNodeName(rawTagName)) {\n      if (rawTagName === `html` || rawTagName === `body`) {\n        const { style, ...nonStyleAttributes } = node.attributes\n\n        htmlAndBodyAttributes[rawTagName] = {\n          ...htmlAndBodyAttributes[rawTagName],\n          ...nonStyleAttributes,\n        }\n\n        // Unfortunately renderToString converts inline styles to a string, so we have to convert them back to an object\n        if (style) {\n          htmlAndBodyAttributes[rawTagName].style = {\n            ...htmlAndBodyAttributes[rawTagName]?.style,\n            ...styleToOjbect(style),\n          }\n        }\n      } else {\n        let element\n        const attributes = { ...node.attributes, \"data-gatsby-head\": true }\n\n        if (rawTagName === `script` || rawTagName === `style`) {\n          element = (\n            <node.rawTagName\n              {...attributes}\n              dangerouslySetInnerHTML={{\n                __html: node.text,\n              }}\n            />\n          )\n        } else {\n          element =\n            node.textContent.length > 0 ? (\n              <node.rawTagName {...attributes}>\n                {node.textContent}\n              </node.rawTagName>\n            ) : (\n              <node.rawTagName {...attributes} />\n            )\n        }\n\n        if (id) {\n          if (!seenIds.has(id)) {\n            validHeadNodes.push(element)\n            seenIds.set(id, validHeadNodes.length - 1)\n          } else {\n            const indexOfPreviouslyInsertedNode = seenIds.get(id)\n            validHeadNodes[indexOfPreviouslyInsertedNode] = element\n          }\n        } else {\n          validHeadNodes.push(element)\n        }\n      }\n    } else {\n      warnForInvalidTag(rawTagName)\n    }\n\n    if (node.childNodes.length) {\n      validHeadNodes.push(\n        ...getValidHeadNodesAndAttributesSSR(node, htmlAndBodyAttributes)\n          .validHeadNodes\n      )\n    }\n  }\n\n  return { validHeadNodes, htmlAndBodyAttributes }\n}\n\nexport function headHandlerForSSR({\n  pageComponent,\n  setHeadComponents,\n  setHtmlAttributes,\n  setBodyAttributes,\n  staticQueryContext,\n  pageData,\n  pagePath,\n}) {\n  if (pageComponent?.Head) {\n    headExportValidator(pageComponent.Head)\n\n    function HeadRouteHandler(props) {\n      const _props = {\n        ...props,\n        ...pageData.result,\n        params: {\n          ...grabMatchParams(props.location.pathname),\n          ...(pageData.result?.pageContext?.__params || {}),\n        },\n      }\n\n      const HeadElement = <pageComponent.Head {...filterHeadProps(_props)} />\n\n      const headWithWrapRootElement = apiRunner(\n        `wrapRootElement`,\n        { element: HeadElement },\n        HeadElement,\n        ({ result }) => {\n          return { element: result }\n        }\n      ).pop()\n\n      return headWithWrapRootElement\n    }\n\n    const routerElement = (\n      <StaticQueryContext.Provider value={staticQueryContext}>\n        <ServerLocation url={`${__BASE_PATH__}${pagePath}`}>\n          <Router\n            baseuri={__BASE_PATH__}\n            component={({ children }) => <>{children}</>}\n          >\n            <HeadRouteHandler path=\"/*\" />\n          </Router>\n        </ServerLocation>\n      </StaticQueryContext.Provider>\n    )\n\n    const rawString = renderToString(routerElement)\n    const rootNode = parse(rawString)\n    const { validHeadNodes, htmlAndBodyAttributes } =\n      getValidHeadNodesAndAttributesSSR(rootNode)\n\n    applyHtmlAndBodyAttributesSSR(htmlAndBodyAttributes, {\n      setHtmlAttributes,\n      setBodyAttributes,\n    })\n\n    setHeadComponents(validHeadNodes)\n  }\n}\n"],"mappings":"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"}